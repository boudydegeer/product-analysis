name: Feature Analysis with Claude Agent SDK

on:
  workflow_dispatch:
    inputs:
      feature_id:
        description: 'Unique identifier for the feature'
        required: true
        type: string
      feature_description:
        description: 'Description of the feature to analyze (or path to markdown file)'
        required: true
        type: string
      callback_url:
        description: 'Optional URL to POST results to'
        required: false
        type: string

jobs:
  analyze-feature:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Claude Agent SDK
        run: |
          npm install -g @anthropic-ai/agent-sdk
          npm install -g axios  # For callback posting

      - name: Validate inputs
        id: validate
        run: |
          echo "feature_id=${{ github.event.inputs.feature_id }}" >> $GITHUB_OUTPUT
          echo "feature_description=${{ github.event.inputs.feature_description }}" >> $GITHUB_OUTPUT
          echo "callback_url=${{ github.event.inputs.callback_url }}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Create analysis script
        run: |
          cat > analyze.js << 'ANALYSIS_SCRIPT'
          const { spawn } = require('child_process');
          const fs = require('fs');
          const path = require('path');

          // Get inputs from environment
          const featureId = process.env.FEATURE_ID;
          const featureDescription = process.env.FEATURE_DESCRIPTION;
          const callbackUrl = process.env.CALLBACK_URL;
          const timestamp = process.env.TIMESTAMP;

          // Check if feature_description is a file path
          let featureContent = featureDescription;
          if (featureDescription.endsWith('.md') && fs.existsSync(featureDescription)) {
            featureContent = fs.readFileSync(featureDescription, 'utf8');
            console.log(`Loaded feature description from: ${featureDescription}`);
          }

          // Prepare the analysis prompt
          const analysisPrompt = `
          You are a senior software architect analyzing a feature request for implementation planning.

          Feature ID: ${featureId}
          Feature Description:
          ${featureContent}

          Repository Context: This is a product analysis repository that appears to contain experiments and analysis tools.

          Please analyze this feature request and provide a structured response with the following:

          1. COMPLEXITY ESTIMATION:
             - Estimated story points (1, 2, 3, 5, 8, 13, 21)
             - Estimated implementation time (hours)
             - Complexity level (Low, Medium, High, Very High)
             - Rationale for the estimation

          2. AFFECTED MODULES/FILES:
             - List all modules or components that would need changes
             - For each, indicate: path, type of change (new/modify/delete), and reason

          3. IMPLEMENTATION TASKS:
             - Break down into specific, actionable tasks
             - Each task should have: description, estimated effort, dependencies, priority
             - Order tasks logically

          4. TECHNICAL RISKS:
             - Identify potential technical challenges
             - Security considerations
             - Performance implications
             - Breaking changes or backward compatibility issues
             - External dependencies or API changes needed

          5. RECOMMENDATIONS:
             - Suggested implementation approach
             - Alternative solutions to consider
             - Testing strategy
             - Deployment considerations

          Please provide your response in valid JSON format with the following structure:
          {
            "feature_id": "${featureId}",
            "complexity": {
              "story_points": number,
              "estimated_hours": number,
              "level": "Low|Medium|High|Very High",
              "rationale": "string"
            },
            "affected_modules": [
              {
                "path": "string",
                "change_type": "new|modify|delete",
                "reason": "string"
              }
            ],
            "implementation_tasks": [
              {
                "id": "string",
                "description": "string",
                "estimated_effort_hours": number,
                "dependencies": ["string"],
                "priority": "high|medium|low"
              }
            ],
            "technical_risks": [
              {
                "category": "security|performance|compatibility|dependencies|other",
                "description": "string",
                "severity": "low|medium|high|critical",
                "mitigation": "string"
              }
            ],
            "recommendations": {
              "approach": "string",
              "alternatives": ["string"],
              "testing_strategy": "string",
              "deployment_notes": "string"
            }
          }
          `;

          // Create a temporary file with the prompt
          const promptFile = '/tmp/analysis-prompt.txt';
          fs.writeFileSync(promptFile, analysisPrompt);

          console.log('Starting Claude Agent SDK analysis...');
          console.log('Feature ID:', featureId);
          console.log('Timestamp:', timestamp);
          console.log('---');

          // Execute Claude Agent SDK
          const claude = spawn('claude', ['--prompt', promptFile], {
            env: {
              ...process.env,
              ANTHROPIC_API_KEY: process.env.ANTHROPIC_API_KEY
            }
          });

          let output = '';
          let errorOutput = '';

          claude.stdout.on('data', (data) => {
            const chunk = data.toString();
            output += chunk;
            process.stdout.write(chunk);
          });

          claude.stderr.on('data', (data) => {
            const chunk = data.toString();
            errorOutput += chunk;
            process.stderr.write(chunk);
          });

          claude.on('close', async (code) => {
            console.log('\n---');
            console.log('Claude Agent SDK completed with code:', code);

            if (code !== 0) {
              console.error('Analysis failed:', errorOutput);
              process.exit(1);
            }

            // Try to extract JSON from the output
            let analysisResult;
            try {
              // Look for JSON in the output (Claude might add markdown formatting)
              const jsonMatch = output.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                analysisResult = JSON.parse(jsonMatch[0]);
              } else {
                // If no JSON found, wrap the output
                analysisResult = {
                  feature_id: featureId,
                  raw_output: output,
                  error: "Could not parse structured JSON from Claude response"
                };
              }
            } catch (parseError) {
              console.error('Failed to parse JSON:', parseError);
              analysisResult = {
                feature_id: featureId,
                raw_output: output,
                error: parseError.message
              };
            }

            // Add metadata
            analysisResult.metadata = {
              analyzed_at: timestamp,
              workflow_run_id: process.env.GITHUB_RUN_ID,
              workflow_run_number: process.env.GITHUB_RUN_NUMBER,
              repository: process.env.GITHUB_REPOSITORY,
              actor: process.env.GITHUB_ACTOR
            };

            // Save results to file
            const outputFile = '/tmp/analysis-result.json';
            fs.writeFileSync(outputFile, JSON.stringify(analysisResult, null, 2));
            console.log('Analysis results saved to:', outputFile);

            // Post to callback URL if provided
            if (callbackUrl && callbackUrl.trim() !== '') {
              console.log('\nPosting results to callback URL:', callbackUrl);
              try {
                const axios = require('axios');
                const response = await axios.post(callbackUrl, analysisResult, {
                  headers: {
                    'Content-Type': 'application/json',
                    'X-Feature-ID': featureId,
                    'X-Workflow-Run-ID': process.env.GITHUB_RUN_ID
                  },
                  timeout: 10000
                });
                console.log('Callback response status:', response.status);
                console.log('Callback response:', response.data);
              } catch (callbackError) {
                console.error('Failed to post to callback URL:', callbackError.message);
                console.log('Note: This is simulated and may fail in testing');
              }
            }

            console.log('\n=== ANALYSIS COMPLETE ===');
            console.log(JSON.stringify(analysisResult, null, 2));
          });
          ANALYSIS_SCRIPT

      - name: Run feature analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          FEATURE_ID: ${{ steps.validate.outputs.feature_id }}
          FEATURE_DESCRIPTION: ${{ steps.validate.outputs.feature_description }}
          CALLBACK_URL: ${{ steps.validate.outputs.callback_url }}
          TIMESTAMP: ${{ steps.validate.outputs.timestamp }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: node analyze.js

      - name: Upload analysis results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: feature-analysis-${{ github.event.inputs.feature_id }}
          path: /tmp/analysis-result.json
          retention-days: 30

      - name: Generate summary
        if: always()
        run: |
          echo "# Feature Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Feature ID:** \`${{ github.event.inputs.feature_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Analyzed at:** ${{ steps.validate.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f /tmp/analysis-result.json ]; then
            echo "## Analysis Summary" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat /tmp/analysis-result.json | head -50 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Full results available in workflow artifacts." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Analysis failed or produced no output" >> $GITHUB_STEP_SUMMARY
          fi
