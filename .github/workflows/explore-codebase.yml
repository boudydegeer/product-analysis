name: Explore Codebase with Claude Agent SDK

on:
  workflow_dispatch:
    inputs:
      exploration_id:
        description: 'Unique identifier for this exploration'
        required: true
        type: string
      query:
        description: 'What to explore in the codebase'
        required: true
        type: string
      scope:
        description: 'Scope of exploration: full, backend, or frontend'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - backend
          - frontend
      focus:
        description: 'Focus area: patterns, files, architecture, dependencies'
        required: false
        default: 'patterns'
        type: choice
        options:
          - patterns
          - files
          - architecture
          - dependencies
      callback_url:
        description: 'Optional URL to POST results to'
        required: false
        type: string

jobs:
  explore-codebase:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      - name: Remove ignored files and directories
        run: |
          echo "Removing directories that should be ignored from exploration..."

          # Python artifacts
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
          rm -rf backend/.venv 2>/dev/null || true
          rm -rf backend/build 2>/dev/null || true
          rm -rf backend/dist 2>/dev/null || true

          # Node.js artifacts
          rm -rf node_modules 2>/dev/null || true
          rm -rf frontend/node_modules 2>/dev/null || true
          rm -rf frontend/dist 2>/dev/null || true

          # IDE and system files
          rm -rf .idea 2>/dev/null || true
          find . -name ".DS_Store" -delete 2>/dev/null || true

          # Git directory (not needed for exploration)
          rm -rf .git 2>/dev/null || true

          echo "Cleanup complete. Remaining structure:"
          du -sh * 2>/dev/null | head -20

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate inputs
        id: validate
        run: |
          echo "exploration_id=${{ github.event.inputs.exploration_id }}" >> $GITHUB_OUTPUT
          echo "query=${{ github.event.inputs.query }}" >> $GITHUB_OUTPUT
          echo "scope=${{ github.event.inputs.scope }}" >> $GITHUB_OUTPUT
          echo "focus=${{ github.event.inputs.focus }}" >> $GITHUB_OUTPUT
          echo "callback_url=${{ github.event.inputs.callback_url }}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Create exploration script
        run: |
          cat > package.json << 'EOF'
          {
            "type": "module",
            "dependencies": {
              "@anthropic-ai/claude-agent-sdk": "*",
              "axios": "*"
            }
          }
          EOF

          cat > explore.js << 'EOF'
          import { query } from '@anthropic-ai/claude-agent-sdk';
          import fs from 'fs';
          import axios from 'axios';

          const explorationId = process.env.EXPLORATION_ID;
          const userQuery = process.env.QUERY;
          const scope = process.env.SCOPE || 'full';
          const focus = process.env.FOCUS || 'patterns';
          const callbackUrl = process.env.CALLBACK_URL;
          const timestamp = process.env.TIMESTAMP;
          const systemPrompt = process.env.SYSTEM_PROMPT;
          const userPromptTemplate = process.env.USER_PROMPT_TEMPLATE;

          const userPrompt = userPromptTemplate
            .replace('{{EXPLORATION_ID}}', explorationId)
            .replace('{{QUERY}}', userQuery)
            .replace('{{SCOPE}}', scope)
            .replace('{{FOCUS}}', focus);

          console.log('Starting Claude Agent SDK codebase exploration...');
          console.log('Exploration ID:', explorationId);
          console.log('Query:', userQuery);
          console.log('Scope:', scope);
          console.log('Focus:', focus);
          console.log('Timestamp:', timestamp);
          console.log('---\n');

          async function runExploration() {
            try {
              const options = {
                systemPrompt: systemPrompt,
                permissionMode: 'bypassPermissions',
                allowDangerouslySkipPermissions: true,
                allowedTools: ['Read', 'Glob', 'Grep', 'Bash'],
                maxTurns: 25,
                maxBudgetUsd: 1.50,
                apiKey: process.env.ANTHROPIC_API_KEY
              };

              console.log('Executing query with SDK...\n');

              let fullOutput = '';
              let resultContent = null;

              for await (const message of query({ prompt: userPrompt, options })) {
                if (message.type === 'system') {
                  console.log('[SYSTEM]', JSON.stringify({
                    model: message.model,
                    tools: message.tools,
                    cwd: message.cwd
                  }));
                } else if (message.type === 'assistant') {
                  const content = message.content || '';
                  fullOutput += content;
                  process.stdout.write(content);
                } else if (message.type === 'result') {
                  console.log('\n[RESULT]', JSON.stringify(message, null, 2));
                  if (message.result) {
                    resultContent = message.result;
                    console.log('\nExtracted result content from message.result');
                  } else if (message.content) {
                    resultContent = message.content;
                    console.log('\nExtracted result content from message.content (fallback)');
                  }
                } else {
                  console.log('\n[' + (message.type?.toUpperCase() || 'UNKNOWN') + ']', message);
                }
              }

              console.log('\n\n---');
              console.log('Claude Agent SDK exploration complete');

              let explorationResult = null;
              const contentToAnalyze = resultContent || fullOutput;

              // Method 1: Try to parse the whole response as JSON (ideal case)
              try {
                explorationResult = JSON.parse(contentToAnalyze.trim());
                console.log('Successfully parsed entire response as JSON (Method 1)');
              } catch (e1) {
                console.log('Method 1 failed (whole response): ' + e1.message);

                // Method 2: Extract from markdown code block ```json ... ``` or ``` ... ```
                const codeBlockMatch = contentToAnalyze.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (codeBlockMatch) {
                  try {
                    explorationResult = JSON.parse(codeBlockMatch[1].trim());
                    console.log('Successfully parsed JSON from markdown code block (Method 2)');
                  } catch (e2) {
                    console.log('Method 2 failed (code block): ' + e2.message);
                  }
                }

                // Method 3: Find and extract JSON object by matching braces
                if (!explorationResult) {
                  console.log('Attempting Method 3: brace matching...');
                  const firstBrace = contentToAnalyze.indexOf('{');
                  if (firstBrace !== -1) {
                    let depth = 0;
                    let start = -1;
                    let end = -1;
                    for (let i = firstBrace; i < contentToAnalyze.length; i++) {
                      if (contentToAnalyze[i] === '{') {
                        if (depth === 0) start = i;
                        depth++;
                      } else if (contentToAnalyze[i] === '}') {
                        depth--;
                        if (depth === 0) {
                          end = i + 1;
                          break;
                        }
                      }
                    }
                    if (start !== -1 && end !== -1) {
                      try {
                        explorationResult = JSON.parse(contentToAnalyze.slice(start, end));
                        console.log('Successfully parsed JSON via brace matching (Method 3)');
                      } catch (e3) {
                        console.log('Method 3 failed (brace matching): ' + e3.message);
                      }
                    }
                  }
                }

                // Method 4: Simple regex for JSON object containing exploration_id
                if (!explorationResult) {
                  console.log('Attempting Method 4: regex extraction...');
                  const jsonMatch = contentToAnalyze.match(/\{[\s\S]*"exploration_id"[\s\S]*\}/);
                  if (jsonMatch) {
                    try {
                      explorationResult = JSON.parse(jsonMatch[0]);
                      console.log('Successfully parsed JSON via regex (Method 4)');
                    } catch (e4) {
                      console.log('Method 4 failed (regex): ' + e4.message);
                    }
                  }
                }
              }

              // If all parsing methods failed, create a structured result from raw response
              if (!explorationResult) {
                console.warn('All JSON parsing methods failed, creating structured result from raw response');
                explorationResult = {
                  exploration_id: explorationId,
                  query: userQuery,
                  status: 'completed',
                  results: {
                    summary: contentToAnalyze.substring(0, 2000),
                    relevant_files: [],
                    key_patterns: [],
                    code_examples: [],
                    architecture_notes: contentToAnalyze,
                    recommendations: [],
                    confidence: 'low',
                    raw_response: contentToAnalyze
                  },
                  parsing_error: 'Could not extract structured JSON from Claude response. Raw response preserved in results.raw_response and results.architecture_notes.'
                };
              }

              // Ensure required fields exist
              if (!explorationResult.exploration_id) {
                explorationResult.exploration_id = explorationId;
              }
              if (!explorationResult.query) {
                explorationResult.query = userQuery;
              }
              if (!explorationResult.status) {
                explorationResult.status = 'completed';
              }

              explorationResult.metadata = {
                scope: scope,
                focus: focus,
                explored_at: timestamp,
                workflow_run_id: process.env.GITHUB_RUN_ID,
                workflow_run_number: process.env.GITHUB_RUN_NUMBER,
                repository: process.env.GITHUB_REPOSITORY,
                actor: process.env.GITHUB_ACTOR
              };

              const outputFile = '/tmp/exploration_result.json';
              fs.writeFileSync(outputFile, JSON.stringify(explorationResult, null, 2));
              console.log('Exploration results saved to:', outputFile);

              if (callbackUrl && callbackUrl.trim() !== '') {
                console.log('\nPosting results to callback URL:', callbackUrl);
                try {
                  const response = await axios.post(callbackUrl, explorationResult, {
                    headers: {
                      'Content-Type': 'application/json',
                      'X-Exploration-ID': explorationId,
                      'X-Workflow-Run-ID': process.env.GITHUB_RUN_ID
                    },
                    timeout: 10000
                  });
                  console.log('Callback response status:', response.status);
                  console.log('Callback response:', response.data);
                } catch (callbackError) {
                  console.error('Failed to post to callback URL:', callbackError.message);
                  if (callbackError.response) {
                    console.error('Response status:', callbackError.response.status);
                    console.error('Response data:', callbackError.response.data);
                  }
                }
              }

              console.log('\n=== EXPLORATION COMPLETE ===');
              console.log(JSON.stringify(explorationResult, null, 2));

            } catch (error) {
              console.error('\nExploration failed with error:');
              console.error(error);

              const errorResult = {
                exploration_id: explorationId,
                query: userQuery,
                status: 'failed',
                error: error.message,
                stack: error.stack,
                results: {
                  summary: 'Exploration failed: ' + error.message,
                  relevant_files: [],
                  key_patterns: [],
                  code_examples: [],
                  architecture_notes: '',
                  recommendations: [],
                  confidence: 'low'
                },
                metadata: {
                  scope: scope,
                  focus: focus,
                  explored_at: timestamp,
                  workflow_run_id: process.env.GITHUB_RUN_ID,
                  workflow_run_number: process.env.GITHUB_RUN_NUMBER,
                  repository: process.env.GITHUB_REPOSITORY,
                  actor: process.env.GITHUB_ACTOR
                }
              };

              const outputFile = '/tmp/exploration_result.json';
              fs.writeFileSync(outputFile, JSON.stringify(errorResult, null, 2));

              process.exit(1);
            }
          }

          runExploration();
          EOF

      - name: Install dependencies
        run: npm install

      - name: Run codebase exploration
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          EXPLORATION_ID: ${{ steps.validate.outputs.exploration_id }}
          QUERY: ${{ steps.validate.outputs.query }}
          SCOPE: ${{ steps.validate.outputs.scope }}
          FOCUS: ${{ steps.validate.outputs.focus }}
          CALLBACK_URL: ${{ steps.validate.outputs.callback_url }}
          TIMESTAMP: ${{ steps.validate.outputs.timestamp }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
          SYSTEM_PROMPT: |
            You are a senior software architect specializing in codebase exploration and understanding.

            SCOPE CONFIGURATION:
            - Scope: {{SCOPE}}
            - If scope is "backend": Focus ONLY on the /backend directory and its contents
            - If scope is "frontend": Focus ONLY on the /frontend directory and its contents
            - If scope is "full": Explore the entire codebase

            FOCUS CONFIGURATION: {{FOCUS}}

            FOCUS INSTRUCTIONS BY TYPE:

            **patterns** - Identify coding patterns and conventions:
            - Look for recurring code patterns and design patterns (Factory, Repository, Singleton, etc.)
            - Note naming conventions for files, classes, functions, variables
            - Find common utilities and helper functions
            - Identify error handling patterns
            - Look for testing patterns and conventions

            **files** - Find relevant files:
            - Identify entry points and main modules
            - Locate configuration files
            - Find related test files
            - Identify files that would need modification for related features

            **architecture** - Understand system architecture:
            - Map out the overall system design and structure
            - Identify main components and their responsibilities
            - Understand data flow and communication patterns
            - Find API endpoints and their handlers
            - Identify database models and relationships
            - Look for service boundaries and integrations

            **dependencies** - Analyze dependencies:
            - Identify external libraries and frameworks
            - Find package manager configurations (package.json, pyproject.toml, etc.)
            - Look for API integrations with external services
            - Identify database and storage dependencies
            - Find infrastructure dependencies (Docker, CI/CD, etc.)

            EXPLORATION METHODOLOGY:

            1. START WITH STRUCTURE:
               - Use Glob to get an overview of the directory structure
               - Identify key directories and their purposes
               - Look at configuration files first (package.json, pyproject.toml, etc.)

            2. DIVE INTO DETAILS:
               - Use Read to examine key files
               - Use Grep to find specific patterns, imports, or function definitions
               - Follow the code flow to understand relationships

            3. GATHER EVIDENCE:
               - Collect specific file paths that are relevant
               - Note code snippets that illustrate patterns
               - Document architectural decisions you observe

            4. OUTPUT REQUIREMENTS:
               - Provide your findings as structured JSON
               - Include specific file paths and code examples
               - Be precise about what you found vs. what you inferred
               - Rate your confidence level based on evidence quality

            IMPORTANT:
            - Be thorough but efficient - focus on what's relevant to the query
            - Provide actionable insights with specific file references
            - If you can't find something, say so rather than guessing
            - Use Markdown formatting in text descriptions for readability

            CRITICAL OUTPUT FORMAT:
            Your final response MUST be ONLY valid JSON. Do not include any markdown code blocks, explanations, or text before or after the JSON. Start your response with { and end with }. No ```json or ``` wrappers.
          USER_PROMPT_TEMPLATE: |
            Explore this codebase to answer the following query:

            Exploration ID: {{EXPLORATION_ID}}
            Query: {{QUERY}}
            Scope: {{SCOPE}}
            Focus: {{FOCUS}}

            Please explore the codebase and provide your findings in the following JSON format:

            {
              "exploration_id": "{{EXPLORATION_ID}}",
              "query": "{{QUERY}}",
              "status": "completed",
              "results": {
                "summary": "A comprehensive summary of your findings (use Markdown formatting)",
                "relevant_files": [
                  {
                    "path": "path/to/file.ext",
                    "purpose": "Brief description of what this file does",
                    "relevance": "Why this file is relevant to the query"
                  }
                ],
                "key_patterns": [
                  {
                    "name": "Pattern name",
                    "description": "Description of the pattern (use Markdown)",
                    "examples": ["path/to/example1.py", "path/to/example2.py"],
                    "usage": "How/where this pattern is used"
                  }
                ],
                "code_examples": [
                  {
                    "file": "path/to/file.ext",
                    "description": "What this code demonstrates",
                    "snippet": "Relevant code snippet (keep it concise)"
                  }
                ],
                "architecture_notes": "Observations about the system architecture (use Markdown formatting with headings, lists, etc.)",
                "recommendations": [
                  {
                    "type": "improvement|observation|warning",
                    "title": "Short title",
                    "description": "Detailed recommendation (use Markdown)"
                  }
                ],
                "confidence": "high|medium|low"
              }
            }

            Begin your exploration now. Use the available tools (Read, Glob, Grep, Bash) to investigate the codebase thoroughly before providing your structured response.

            REMINDER: Your final output must be ONLY valid JSON - no markdown, no code blocks, no explanations. Start with { and end with }.
        run: node explore.js

      - name: Upload exploration results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: exploration-results-${{ github.event.inputs.exploration_id }}
          path: /tmp/exploration_result.json
          retention-days: 7

      - name: Generate summary
        if: always()
        run: |
          echo "# Codebase Exploration Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Exploration ID:** \`${{ github.event.inputs.exploration_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Query:** ${{ github.event.inputs.query }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scope:** ${{ github.event.inputs.scope }}" >> $GITHUB_STEP_SUMMARY
          echo "**Focus:** ${{ github.event.inputs.focus }}" >> $GITHUB_STEP_SUMMARY
          echo "**Explored at:** ${{ steps.validate.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f /tmp/exploration_result.json ]; then
            echo "## Exploration Summary" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat /tmp/exploration_result.json | head -100 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Full results available in workflow artifacts." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Exploration failed or produced no output" >> $GITHUB_STEP_SUMMARY
          fi
